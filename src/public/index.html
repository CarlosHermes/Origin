<!DOCTYPE html>
<html>
    <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>TestSocket</title>
        <!--<link rel="stylesheet" href="cssJavascript.css" type="text/css" />-->
        <script src='/socket.io/socket.io.js'></script>
        <script>
            let userLogged = {a:''};
            var socketTriggers = ["coins", "ingots", "level"];
            var request = new XMLHttpRequest();

            function logged(){
                const socket = io();
                socket.on('time', (timeString) => {
                    el = document.getElementById('server-time')
                    el.innerHTML = 'Server time: ' + timeString;
                });
                socket.on('usersUpdate', (data) => {
                    lo = document.getElementById('usersUpdate')
                    lo.innerHTML += data.User.userName;
                });
            }
            function action(REQ, action, url, data2)
            {
                    request.onload = function () {
                        var jsonDoc = this.responseText;
                        //jsonDoc = JSON.parse(jsonDoc);
                        //jsonDoc = JSON.stringify(jsonDoc);
                        document.getElementById(action).innerHTML = jsonDoc;
                        if (action=='login')
                        {
                            userLogged.a = jsonDoc.search('false')==-1? '': data2.userName;
                            logged();
                        }
                    }
                    //request.onerror = function(){ alert(request.responseText); }
                    request.open(REQ, url, true);
                    request.setRequestHeader('Content-Type', 'application/json');
                    request.send(JSON.stringify(data2));
            }
            function server(){
                action('GET', 'server', '/api/', '')
            }
            function login(){
                data = { userName: username.value, password: password.value }
                action('POST', 'login', '/api/login', data)
            }
            function logout(){
                document.getElementById('login').innerHTML = userLogged.a == ''? 'you did not log in' : 'logged out';
                userLogged.a = '';
            }

            function register(){
                data = { password: password2.value }
                action('POST', 'register', '/api/users/'+ document.getElementById('username2').value, data)
            }

            function updateField(){
                data = { field: field.value, value : value.value }
                data.value = data.field != "password"? parseInt(data.value): data.value;
                if (userLogged.a != '') {
                    data.userName = userLogged.a;
                    if (socketTriggers.findIndex(j => j == data.field)!= -1)
                        {
                            socket.emit('update', data);
                            //usersUpdate(data2);
                        }
                    else {
                        action('PUT', 'update', '/api/users/'+ userLogged.a, data)
                    }
                }
            }
            
            function ranking(){
                action('GET', 'ranking', '/api/ranking', '')
            }
            function myData(){
                action('GET', 'myData', '/api/users/' + userLogged.a, '')
            }
            function deleteUser(){
                data = { password : password3.value }
                action('DELETE', 'delete', '/api/users/'+ userLogged.a, data)
            }

            ////////////////////////////////////////////////////////////////////////////////////////////
            ////////////////////////////////////////////////////////////////////////////////////////////
        </script>
    </head>
    <body>
        <div class="general">
            <div>
                <h1>ServerStatus</h1>
                <div class="buttons">
                    <button onclick="server()">server</button>
                    <!--<button onclick="getResp('server')">server</button>
                    <button onclick="requestSend('GET', '/api', 'server', '')">server</button>-->
                </div>
                <div>
                    <p id="server"></p>
                </div>
                <div>
                    <p id="server-time"></p>
                </div>
                <div>
                    ______________________
                </div>
                <h1>Login</h1>
                <div>
                    <input type="string" id="username">
                </div>
                <div>
                    <input type="string" id="password">
                </div>
                <div class="buttons">
                    <button onclick="login()">login</button>
                    <button onclick="logout()">logout</button>
                </div>
                <div>
                    <p id="login"></p>
                </div>
                <div>
                    ______________________
                </div>
                <h1>Register</h1>

                <div>
                    <input type="string" id="username2">
                </div>
                <div>
                    <input type="string" id="password2">
                </div>
                <div class="buttons">
                    <button onclick="register()">register</button>
                </div>
                <div>
                    <p id="register"></p>
                </div>
                <div>
                    ______________________
                </div>
                <div class="buttons">
                    <button onclick="ranking()">ranking</button>
                </div>
                <div>
                    <p id="ranking"></p>
                </div>
                <div>
                    ______________________
                </div>
                <div class="buttons">
                    <button onclick="myData()">myData</button>
                </div>
                <div>
                    <p id="myData"></p>
                </div>
                <div>
                    ______________________
                </div>
                <h1>Update Field</h1>
                <div>
                    <input type="string" id="field">
                </div>
                <div>
                    <input type="string" id="value">
                </div>
                <div class="buttons">
                    <button onclick="updateField()">update</button>
                </div>
                <div>
                    <p id="update"></p>
                </div>
                <div>
                    ______________________
                </div>
                <h1>DeleteUser</h1>
                <div>
                    <input type="string" id="password3">
                </div>
                <div class="buttons">
                    <button onclick="deleteUser()">delete</button>
                </div>
                <div>
                    <p id="delete"></p>
                </div>
                <div>
                    ______________________
                </div>
                <h1>Users Updates</h1>
                <div>
                    <p id="usersUpdate"></p>
                </div>
                <div>
                    ______________________
        </div>
        </div>
    </body>
</html>